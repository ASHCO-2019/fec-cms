import dateutil.parser
import requests

from django import template
from django.conf import settings


register = template.Library()

@register.inclusion_tag('partials/jobs.html')
def get_jobs():
    url = 'https://data.usajobs.gov/api/Search'
    codes_url = 'https://data.usajobs.gov/api/codelist/hiringpaths'
    querystring = {'Organization':'LF00','WhoMayApply':'All'}

    headers = {
        'authorization-key': settings.USAJOBS_API_KEY,
        'user-agent': 'jcarroll@fec.gov',
        'host': 'data.usajobs.gov',
        'cache-control': 'no-cache',
    }

    #query usajobs API for all open fec jobs
    response = requests.get(
        url,
        headers=headers,
        params=querystring
    )

    #query usajobs API for list of all hiring-path codes
    codes_response = requests.get(
        codes_url,
        headers=headers
    )

    responses = {"LanguageCode":"EN","SearchParameters":{},"SearchResult":{"SearchResultCount":4,"SearchResultCountAll":4,"SearchResultItems":[{"MatchedObjectId":"493165900","MatchedObjectDescriptor":{"PositionID":"FEC-18-021","PositionTitle":"Chief Financial Officer","PositionURI":"https://www.usajobs.gov:443/GetJob/ViewDetails/493165900","ApplyURI":["https://www.usajobs.gov:443/GetJob/ViewDetails/493165900?PostingChannelID=RESTAPI"],"PositionLocationDisplay":"Washington DC, District of Columbia","PositionLocation":[{"LocationName":"Washington DC, District of Columbia","CountryCode":"United States","CountrySubDivisionCode":"District of Columbia","CityName":"Washington DC, District of Columbia","Longitude":-77.032,"Latitude":38.8904}],"OrganizationName":"Federal Election Commission","DepartmentName":"Other Agencies and Independent Organizations","JobCategory":[{"Name":"Financial Administration And Program","Code":"0501"}],"JobGrade":[{"Code":"SL"}],"PositionSchedule":[{"Name":"Full-Time","Code":"1"}],"PositionOfferingType":[{"Name":"Permanent","Code":"15317"}],"QualificationSummary":"Minimum Requirement: Applicants must demonstrate professional, executive level financial management in multiple program areas, responsible leadership experience that is indicative of senior level managerial capability and directly related to the skills and abilities serving as a senior advisor on financial matters, managing financial offices, managing financial policy and systems. Typically, experience of this nature will have been gained at the GS-15 grade level in the Federal service or its equivalent with state or local government, the private sector, or nongovernmental organizations. Failure to meet required minimum requirement automatically disqualifies an applicant. Experience refers to paid and unpaid experience, including volunteer work done through National Service programs (e.g.; Peace Corps, AmeriCorps) and other organizations (e.g.; professional, philanthropic, religious, spiritual, community, student, social). Volunteer work helps build critical competencies, knowledge and skills and can provide valuable training and experience that translates directly to paid employment. You will receive credit for all qualifying experience, including volunteer experience. Time in Grade: Current Federal employees must have served 52 weeks at the next lower grade or equivalent grade band in the Federal service. All qualifications and time-in-grade requirements must be met by the closing date of this announcement. You must demonstrate in your application significant achievements, increasing levels of responsibility as a manager, and a solid record of successful professional performance. Applicants must submit a cover letter not exceeding two pages summarizing their experience that relates to the minimum requirements stated in the above qualifications section of this announcement. Failure to submit a cover letter will result in your not being considered for this position and will deem the applicant ineligible for further consideration.","PositionRemuneration":[{"MinimumRange":"126148.00","MaximumRange":"174500.00","RateIntervalCode":"Per Year"}],"PositionStartDate":"2018-03-06","PositionEndDate":"2018-04-02","PublicationStartDate":"2018-03-06","ApplicationCloseDate":"2018-04-02","PositionFormattedDescription":[{"Label":"Dynamic Teaser","LabelDescription":"Hit highlighting for keyword searches."}],"UserArea":{"Details":{"JobSummary":"*This position is being announced concurrently under job announcement number: FEC 18-019 to all U.S. Citizens. Applicants who wish to be considered under both announcements must apply to both vacancies separately.* The CFO serves as the primary technical and policy advisor to the Commission concerning the development of the FEC's financial objective, policies, and plans to include, acquisitions and procurement; financial systems; budgeting and accounting; internal controls; cash management; credit and debt management; compliance guidelines; and corrective actions relating to audit recommendations. The Chief Financial Officer (CFO) leads the Office of the Chief Financial Officer in its support of the work of the Commission to fulfill its mission.","WhoMayApply":{"Name":"","Code":""},"LowGrade":"00","HighGrade":"00","HiringPath":["fed-competitive","fed-excepted","vet"]},"IsRadialSearch":"false"}},"RelevanceRank":0.0},{"MatchedObjectId":"493166000","MatchedObjectDescriptor":{"PositionID":"FEC-18-019","PositionTitle":"Chief Financial Officer","PositionURI":"https://www.usajobs.gov:443/GetJob/ViewDetails/493166000","ApplyURI":["https://www.usajobs.gov:443/GetJob/ViewDetails/493166000?PostingChannelID=RESTAPI"],"PositionLocationDisplay":"Washington DC, District of Columbia","PositionLocation":[{"LocationName":"Washington DC, District of Columbia","CountryCode":"United States","CountrySubDivisionCode":"District of Columbia","CityName":"Washington DC, District of Columbia","Longitude":-77.032,"Latitude":38.8904}],"OrganizationName":"Federal Election Commission","DepartmentName":"Other Agencies and Independent Organizations","JobCategory":[{"Name":"Financial Administration And Program","Code":"0501"}],"JobGrade":[{"Code":"SL"}],"PositionSchedule":[{"Name":"Full-Time","Code":"1"}],"PositionOfferingType":[{"Name":"Permanent","Code":"15317"}],"QualificationSummary":"Minimum Requirement: Applicants must demonstrate professional, executive level financial management in multiple program areas, responsible leadership experience that is indicative of senior level managerial capability and directly related to the skills and abilities serving as a senior advisor on financial matters, managing financial offices, managing financial policy and systems. Typically, experience of this nature will have been gained at the GS-15 grade level in the Federal service or its equivalent with state or local government, the private sector, or nongovernmental organizations. Failure to meet required minimum requirement automatically disqualifies an applicant. Experience refers to paid and unpaid experience, including volunteer work done through National Service programs (e.g.; Peace Corps, AmeriCorps) and other organizations (e.g.; professional, philanthropic, religious, spiritual, community, student, social). Volunteer work helps build critical competencies, knowledge and skills and can provide valuable training and experience that translates directly to paid employment. You will receive credit for all qualifying experience, including volunteer experience. Time in Grade: Current Federal employees must have served 52 weeks at the next lower grade or equivalent grade band in the Federal service. All qualifications and time-in-grade requirements must be met by the closing date of this announcement. You must demonstrate in your application significant achievements, increasing levels of responsibility as a manager, and a solid record of successful professional performance. Applicants must submit a cover letter not exceeding two pages summarizing their experience that relates to the minimum requirements stated in the above qualifications section of this announcement. Failure to submit a cover letter will result in your not being considered for this position and will deem the applicant ineligible for further consideration.","PositionRemuneration":[{"MinimumRange":"126148.00","MaximumRange":"174500.00","RateIntervalCode":"Per Year"}],"PositionStartDate":"2018-03-06","PositionEndDate":"2018-04-02","PublicationStartDate":"2018-03-06","ApplicationCloseDate":"2018-04-02","PositionFormattedDescription":[{"Label":"Dynamic Teaser","LabelDescription":"Hit highlighting for keyword searches."}],"UserArea":{"Details":{"JobSummary":"*This position is being announced concurrently under job announcement number: FEC 18-021 to Status Candidates, Excepted Service (Merit Promotion and VEOA Eligibles). Applicants who wish to be considered under both announcements must apply to both vacancies separately.* The CFO serves as the primary technical and policy advisor to the Commission concerning the development of the FEC's financial objective, policies, and plans to include, acquisitions and procurement; financial systems; budgeting and accounting; internal controls; cash management; credit and debt management; compliance guidelines; and corrective actions relating to audit recommendations. The Chief Financial Officer (CFO) leads the Office of the Chief Financial Officer in its support of the work of the Commission to fulfill its mission.","WhoMayApply":{"Name":"","Code":""},"LowGrade":"00","HighGrade":"00","HiringPath":["public"]},"IsRadialSearch":"false"}},"RelevanceRank":0.0},{"MatchedObjectId":"493436900","MatchedObjectDescriptor":{"PositionID":"FEC-18-020","PositionTitle":"Inspector General","PositionURI":"https://www.usajobs.gov:443/GetJob/ViewDetails/493436900","ApplyURI":["https://www.usajobs.gov:443/GetJob/ViewDetails/493436900?PostingChannelID=RESTAPI"],"PositionLocationDisplay":"Washington DC, District of Columbia","PositionLocation":[{"LocationName":"Washington DC, District of Columbia","CountryCode":"United States","CountrySubDivisionCode":"District of Columbia","CityName":"Washington DC, District of Columbia","Longitude":-77.032,"Latitude":38.8904}],"OrganizationName":"Federal Election Commission","DepartmentName":"Other Agencies and Independent Organizations","JobCategory":[{"Name":"Miscellaneous Administration And Program","Code":"0301"}],"JobGrade":[{"Code":"SL"}],"PositionSchedule":[{"Name":"Full-Time","Code":"1"}],"PositionOfferingType":[{"Name":"Permanent","Code":"15317"}],"QualificationSummary":"Minimum Requirement: Applicants must demonstrate professional, executive level responsibilities in multiple program areas, responsible leadership experience that is indicative of senior level managerial capability that is directly related to the skills and abilities with progressively responsible experience in providing leadership, direction and coordination in improving the economy, efficiency and effectiveness of an agency/organization's operations and detecting and preventing waste, fraud and abuse within the organization. Typically, experience of this nature will have been gained at the GS-15 grade level in the Federal service or its equivalent with state or local government, the private sector, or nongovernmental organizations. Failure to meet required minimum requirement automatically disqualifies an applicant. Experience refers to paid and unpaid experience, including volunteer work done through National Service programs (e.g.; Peace Corps, AmeriCorps) and other organizations (e.g.; professional, philanthropic, religious, spiritual, community, student, social). Volunteer work helps build critical competencies, knowledge and skills and can provide valuable training and experience that translates directly to paid employment. You will receive credit for all qualifying experience, including volunteer experience. Time in Grade: Current Federal employees must have served 52 weeks at the next lower grade or equivalent grade band in the Federal service. All qualifications and time-in-grade requirements must be met by the closing date of this announcement. You must demonstrate in your application significant achievements, increasing levels of responsibility as a manager, and a solid record of successful professional performance. Applicants must submit a cover letter not exceeding two pages summarizing their experience that relates to the minimum requirements stated in the above qualifications section of this announcement. Failure to submit a cover letter will result in your not being considered for this position and will deem the applicant ineligible for further consideration.","PositionRemuneration":[{"MinimumRange":"126148.00","MaximumRange":"174500.00","RateIntervalCode":"Per Year"}],"PositionStartDate":"2018-03-08","PositionEndDate":"2018-04-04","PublicationStartDate":"2018-03-08","ApplicationCloseDate":"2018-04-04","PositionFormattedDescription":[{"Label":"Dynamic Teaser","LabelDescription":"Hit highlighting for keyword searches."}],"UserArea":{"Details":{"JobSummary":"*This position is being announced concurrently under job announcement number: FEC 18-022 to all U.S. Citizens. Applicants who wish to be considered under both announcements must apply to both vacancies separately.* The incumbent serves as the Inspector General (IG) for the FEC. The IG for the FEC is responsible for carrying out and supervising the functions, powers, and duties of the Office of the Inspector General (OIG) as provided in the Inspector General Act of 1978, as amended (IG Act).\nThe incumbent is appointed by FEC Commission and is under the general supervision of the Commission; however the OIG is established by statute with organizational independence and broad authority. The IG's independence requires that he/she be precluded from any program operating responsibilities, unless otherwise specified in the IG Act or required by law. The incumbent has independent authority to appoint OIG staff, budget for funds, and sign contracts. The IG is to provide leadership and coordination and recommend policies for activities designed to (1) promote economy, efficiency, and effectiveness in the administration of FEC programs and operations; and (2) detect and prevent waste, fraud, and abuse in FEC programs and operations. The IG keeps the FEC Commissioners and Congress fully informed about problems and deficiencies relating to program administration and operations, the necessity for corrective actions, and progress in their implementation.","WhoMayApply":{"Name":"","Code":""},"LowGrade":"00","HighGrade":"00","HiringPath":["fed-competitive","fed-excepted","vet"]},"IsRadialSearch":"false"}},"RelevanceRank":0.0},{"MatchedObjectId":"493439000","MatchedObjectDescriptor":{"PositionID":"FEC-18-022","PositionTitle":"Inspector General","PositionURI":"https://www.usajobs.gov:443/GetJob/ViewDetails/493439000","ApplyURI":["https://www.usajobs.gov:443/GetJob/ViewDetails/493439000?PostingChannelID=RESTAPI"],"PositionLocationDisplay":"Washington DC, District of Columbia","PositionLocation":[{"LocationName":"Washington DC, District of Columbia","CountryCode":"United States","CountrySubDivisionCode":"District of Columbia","CityName":"Washington DC, District of Columbia","Longitude":-77.032,"Latitude":38.8904}],"OrganizationName":"Federal Election Commission","DepartmentName":"Other Agencies and Independent Organizations","JobCategory":[{"Name":"Miscellaneous Administration And Program","Code":"0301"}],"JobGrade":[{"Code":"SL"}],"PositionSchedule":[{"Name":"Full-Time","Code":"1"}],"PositionOfferingType":[{"Name":"Permanent","Code":"15317"}],"QualificationSummary":"Minimum Requirement: Applicants must demonstrate professional, executive level responsibilities in multiple program areas, responsible leadership experience that is indicative of senior level managerial capability and directly related to the skills and abilities progressively responsible experience in providing leadership, direction and coordination in improving the economy, efficiency and effectiveness of an agency/organization's operations and detecting and preventing waste, fraud and abuse within the organization. Typically, experience of this nature will have been gained at the GS-15 grade level in the Federal service or its equivalent with state or local government, the private sector, or nongovernmental organizations. Failure to meet required minimum requirement automatically disqualifies an applicant. Experience refers to paid and unpaid experience, including volunteer work done through National Service programs (e.g.; Peace Corps, AmeriCorps) and other organizations (e.g.; professional, philanthropic, religious, spiritual, community, student, social). Volunteer work helps build critical competencies, knowledge and skills and can provide valuable training and experience that translates directly to paid employment. You will receive credit for all qualifying experience, including volunteer experience. Time in Grade: Current Federal employees must have served 52 weeks at the next lower grade or equivalent grade band in the Federal service. All qualifications and time-in-grade requirements must be met by the closing date of this announcement. You must demonstrate in your application significant achievements, increasing levels of responsibility as a manager, and a solid record of successful professional performance. Applicants must submit a cover letter not exceeding two pages summarizing their experience that relates to the minimum requirements stated in the above qualifications section of this announcement. Failure to submit a cover letter will result in your not being considered for this position and will deem the applicant ineligible for further consideration.","PositionRemuneration":[{"MinimumRange":"126148.00","MaximumRange":"174500.00","RateIntervalCode":"Per Year"}],"PositionStartDate":"2018-03-08","PositionEndDate":"2018-04-04","PublicationStartDate":"2018-03-08","ApplicationCloseDate":"2018-04-04","PositionFormattedDescription":[{"Label":"Dynamic Teaser","LabelDescription":"Hit highlighting for keyword searches."}],"UserArea":{"Details":{"JobSummary":"*This position is being announced concurrently under job announcement number: FEC 18-020 to Status Candidates, Excepted Service (Merit Promotion and VEOA Eligibles). Applicants who wish to be considered under both announcements must apply to both vacancies separately.* The incumbent serves as the Inspector General (IG) for the FEC. The IG for the FEC is responsible for carrying out and supervising the functions, powers, and duties of the Office of the Inspector General (OIG) as provided in the Inspector General Act of 1978, as amended (IG Act).\nThe incumbent is appointed by FEC Commission and is under the general supervision of the Commission; however the OIG is established by statute with organizational independence and broad authority. The IG's independence requires that he/she be precluded from any program operating responsibilities, unless otherwise specified in the IG Act or required by law. The incumbent has independent authority to appoint OIG staff, budget for funds, and sign contracts.\nThe IG is to provide leadership and coordination and recommend policies for activities designed to (1) promote economy, efficiency, and effectiveness in the administration of FEC programs and operations; and (2) detect and prevent waste, fraud, and abuse in FEC programs and operations. The IG keeps the FEC Commissioners and Congress fully informed about problems and deficiencies relating to program administration and operations, the necessity for corrective actions, and progress in their implementation.","WhoMayApply":{"Name":"","Code":""},"LowGrade":"00","HighGrade":"00","HiringPath":["public"]},"IsRadialSearch":"false"}},"RelevanceRank":0.0}],"UserArea":{"NumberOfPages":"1","IsRadialSearch":"false"}}}
    codes_responses = codes_response.json()

    jobData = []
    search_results = responses.get('SearchResult', {})

    #iterate over returned job data
    if 'SearchResultItems' in search_results:
        for result in search_results.get('SearchResultItems', None):
            matched_object_descriptor = result.get('MatchedObjectDescriptor', {})
            if len(matched_object_descriptor.get('JobGrade', [])) > 0:
                job_grade = matched_object_descriptor.get('JobGrade', [])[0].get('Code', '')
            else:
                job_grade = ''


            jobs_dict = {
                'position_title': matched_object_descriptor.get('PositionTitle', ''),
                'position_id': matched_object_descriptor.get('PositionID', ''),
                'position_uri': matched_object_descriptor.get('PositionURI', ''),
                'position_start_date': dateutil.parser.parse(matched_object_descriptor.get('PositionStartDate', '')),
                'position_end_date': dateutil.parser.parse(matched_object_descriptor.get('PositionEndDate', '')),
                'job_grade' : job_grade,
                'low_grade': matched_object_descriptor.get('UserArea', {}).get('Details', {}).get('LowGrade', ''),
                'high_grade': matched_object_descriptor.get('UserArea', {}).get('Details', {}).get('HighGrade', '')
            }
            #map hiring-path code(s) for each job to description(s)
            hiring_path_codes = codes_responses.get('CodeList', [])[0].get('ValidValue')
            hiring_path = [item for item in result.get('MatchedObjectDescriptor', {}).get('UserArea', {}).get('Details', {}).get('HiringPath', [])]
            hp = []
            for path in hiring_path:
                hpa = [item for item in hiring_path_codes if item['Code'] == path.upper()]
                hp.append(hpa[0].get('Value', ''))
                hiring_path_list = ', '.join(str(n) for n in hp)
                open_to = {'open_to':hiring_path_list}
            jobs_dict.update(open_to)
            jobData.append(jobs_dict)

    return {'jobData': jobData }
